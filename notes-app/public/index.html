<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Notes</title>
<style>
/* ===== Reset & Base ===== */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg-0: #0f1117; --bg-1: #161822; --bg-2: #1e2030; --bg-3: #282a3a;
  --border: #2e3148; --text-0: #e2e4f0; --text-1: #a0a4c0; --text-2: #6b6f8a;
  --accent: #7c6ef0; --accent-dim: #5a4fcf; --accent-bg: rgba(124,110,240,.1);
  --green: #6dd99a; --yellow: #f0d06c; --red: #f06c6c;
  --radius: 10px; --sidebar-w: 220px; --list-w: 340px;
  --font: -apple-system, BlinkMacSystemFont, 'Inter', 'SF Pro', sans-serif;
  --mono: 'SF Mono', 'Fira Code', monospace;
}
html, body { height: 100%; font-family: var(--font); background: var(--bg-0); color: var(--text-0); font-size: 14px; }
input, textarea, button, select { font-family: inherit; font-size: inherit; color: inherit; }
button { cursor: pointer; border: none; background: none; }
a { color: var(--accent); text-decoration: none; }

/* ===== Layout ===== */
.app { display: flex; height: 100vh; overflow: hidden; }
.sidebar { width: var(--sidebar-w); background: var(--bg-1); border-right: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; overflow-y: auto; }
.note-list-panel { width: var(--list-w); background: var(--bg-0); border-right: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; overflow: hidden; }
.editor-panel { flex: 1; display: flex; flex-direction: column; background: var(--bg-0); overflow: hidden; }

/* ===== Sidebar ===== */
.sidebar-header { padding: 20px 16px 12px; font-size: 18px; font-weight: 700; letter-spacing: -.3px; display: flex; align-items: center; gap: 8px; }
.sidebar-header .logo { width: 22px; height: 22px; background: var(--accent); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 800; color: #fff; }
.sidebar-section { padding: 4px 8px; }
.sidebar-label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: .8px; color: var(--text-2); padding: 12px 8px 6px; }
.sidebar-item { display: flex; align-items: center; gap: 8px; padding: 7px 10px; border-radius: 7px; color: var(--text-1); transition: all .15s; font-size: 13px; }
.sidebar-item:hover { background: var(--bg-2); color: var(--text-0); }
.sidebar-item.active { background: var(--accent-bg); color: var(--accent); }
.sidebar-item .count { margin-left: auto; font-size: 11px; color: var(--text-2); min-width: 18px; text-align: right; }
.sidebar-item .icon { font-size: 15px; width: 20px; text-align: center; }

/* ===== Note List ===== */
.list-header { padding: 12px 16px; border-bottom: 1px solid var(--border); display: flex; flex-direction: column; gap: 8px; }
.list-header-row { display: flex; align-items: center; gap: 8px; }
.search-box { flex: 1; background: var(--bg-2); border: 1px solid var(--border); border-radius: 8px; padding: 8px 12px; color: var(--text-0); outline: none; transition: border-color .2s; }
.search-box:focus { border-color: var(--accent); }
.search-box::placeholder { color: var(--text-2); }
.btn-new { background: var(--accent); color: #fff; padding: 8px 14px; border-radius: 8px; font-weight: 600; font-size: 13px; white-space: nowrap; transition: background .15s; }
.btn-new:hover { background: var(--accent-dim); }
.note-list { flex: 1; overflow-y: auto; padding: 4px 0; }
.note-card { padding: 12px 16px; border-bottom: 1px solid var(--border); cursor: pointer; transition: background .12s; }
.note-card:hover { background: var(--bg-1); }
.note-card.active { background: var(--bg-2); border-left: 3px solid var(--accent); }
.note-card-title { font-weight: 600; font-size: 13.5px; margin-bottom: 3px; display: flex; align-items: center; gap: 6px; }
.note-card-title .pin { color: var(--yellow); font-size: 12px; }
.note-card-preview { color: var(--text-2); font-size: 12px; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; margin-bottom: 6px; }
.note-card-meta { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
.note-card-meta .tag { font-size: 11px; color: var(--accent); background: var(--accent-bg); padding: 1px 6px; border-radius: 4px; }
.note-card-meta .time { font-size: 11px; color: var(--text-2); margin-left: auto; }
.empty-state { padding: 40px 20px; text-align: center; color: var(--text-2); }

/* ===== Editor ===== */
.editor-topbar { padding: 12px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 8px; }
.editor-topbar .title-input { flex: 1; background: none; border: none; font-size: 15px; font-weight: 600; color: var(--text-0); outline: none; }
.editor-topbar .title-input::placeholder { color: var(--text-2); }
.editor-actions { display: flex; gap: 4px; }
.editor-actions button { padding: 6px 10px; border-radius: 6px; font-size: 12px; color: var(--text-1); transition: all .15s; }
.editor-actions button:hover { background: var(--bg-2); color: var(--text-0); }
.editor-actions button.active { color: var(--yellow); }
.editor-meta { padding: 8px 20px; display: flex; align-items: center; gap: 8px; border-bottom: 1px solid var(--border); flex-wrap: wrap; }
.editor-meta select, .editor-meta input { background: var(--bg-2); border: 1px solid var(--border); border-radius: 6px; padding: 4px 8px; font-size: 12px; color: var(--text-1); outline: none; }
.editor-meta select:focus, .editor-meta input:focus { border-color: var(--accent); }
.editor-meta label { font-size: 11px; color: var(--text-2); }
.editor-body { flex: 1; overflow-y: auto; }
.editor-textarea { width: 100%; height: 100%; background: none; border: none; resize: none; padding: 20px; color: var(--text-0); line-height: 1.7; font-size: 14px; outline: none; font-family: var(--font); }
.editor-textarea::placeholder { color: var(--text-2); }
.markdown-view { padding: 20px; line-height: 1.7; overflow-y: auto; height: 100%; }
.markdown-view h1, .markdown-view h2, .markdown-view h3 { margin: 16px 0 8px; font-weight: 700; }
.markdown-view h1 { font-size: 22px; } .markdown-view h2 { font-size: 18px; } .markdown-view h3 { font-size: 15px; }
.markdown-view p { margin-bottom: 10px; }
.markdown-view code { background: var(--bg-2); padding: 2px 6px; border-radius: 4px; font-family: var(--mono); font-size: 13px; }
.markdown-view pre { background: var(--bg-2); padding: 14px; border-radius: 8px; overflow-x: auto; margin-bottom: 12px; }
.markdown-view pre code { background: none; padding: 0; }
.markdown-view ul, .markdown-view ol { padding-left: 24px; margin-bottom: 10px; }
.markdown-view blockquote { border-left: 3px solid var(--accent); padding-left: 14px; color: var(--text-1); margin-bottom: 10px; }
.markdown-view a { color: var(--accent); }
.markdown-view strong { color: var(--text-0); }
.editor-placeholder { display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-2); font-size: 15px; flex-direction: column; gap: 8px; }
.editor-placeholder kbd { background: var(--bg-2); padding: 3px 8px; border-radius: 5px; font-size: 12px; font-family: var(--mono); }

/* ===== Quick Capture Bar ===== */
.quick-capture { padding: 12px 16px; border-top: 1px solid var(--border); }
.quick-capture input { width: 100%; background: var(--bg-2); border: 1px solid var(--border); border-radius: 8px; padding: 10px 14px; color: var(--text-0); outline: none; font-size: 13px; transition: border-color .2s; }
.quick-capture input:focus { border-color: var(--accent); }
.quick-capture input::placeholder { color: var(--text-2); }

/* ===== Scrollbar ===== */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--bg-3); border-radius: 3px; }

/* ===== Toast ===== */
.toast { position: fixed; bottom: 20px; right: 20px; background: var(--bg-2); border: 1px solid var(--border); color: var(--text-0); padding: 10px 18px; border-radius: 8px; font-size: 13px; opacity: 0; transition: opacity .3s; pointer-events: none; z-index: 999; }
.toast.show { opacity: 1; }

/* ===== Mobile ===== */
@media (max-width: 900px) {
  .sidebar { display: none; }
  .note-list-panel { width: 100%; }
  .editor-panel { position: fixed; inset: 0; z-index: 10; display: none; }
  .editor-panel.mobile-open { display: flex; }
  .mobile-back { display: block !important; }
}
@media (min-width: 901px) {
  .mobile-back { display: none !important; }
}
</style>
</head>
<body>
<div class="app">
  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header"><div class="logo">N</div> Notes</div>

    <div class="sidebar-section">
      <div class="sidebar-item active" data-filter="all" onclick="filterNotes('all')">
        <span class="icon">üìã</span> All Notes <span class="count" id="count-all">0</span>
      </div>
      <div class="sidebar-item" data-filter="pinned" onclick="filterNotes('pinned')">
        <span class="icon">‚≠ê</span> Pinned <span class="count" id="count-pinned">0</span>
      </div>
      <div class="sidebar-item" data-filter="archived" onclick="filterNotes('archived')">
        <span class="icon">üóÑÔ∏è</span> Archive <span class="count" id="count-archived">0</span>
      </div>
    </div>

    <div class="sidebar-section">
      <div class="sidebar-label">Categories</div>
      <div id="category-list"></div>
    </div>

    <div class="sidebar-section">
      <div class="sidebar-label">Tags</div>
      <div id="tag-list"></div>
    </div>
  </aside>

  <!-- Note List -->
  <div class="note-list-panel">
    <div class="list-header">
      <div class="list-header-row">
        <input type="text" class="search-box" id="search" placeholder="Search notes‚Ä¶ (‚åòK)" />
        <button class="btn-new" id="btn-new" onclick="newNote()">+ New</button>
      </div>
    </div>
    <div class="note-list" id="note-list"></div>
    <div class="quick-capture">
      <input type="text" id="quick-input" placeholder="Quick capture ‚Äî type and hit Enter" />
    </div>
  </div>

  <!-- Editor -->
  <div class="editor-panel" id="editor-panel">
    <div id="editor-content" style="display:none; flex-direction:column; height:100%;">
      <div class="editor-topbar">
        <button class="mobile-back" onclick="closeEditor()" style="font-size:18px;">‚Üê</button>
        <input type="text" class="title-input" id="editor-title" placeholder="Note title‚Ä¶" />
        <div class="editor-actions">
          <button id="btn-pin" onclick="togglePin()" title="Pin">‚≠ê</button>
          <button id="btn-preview" onclick="togglePreview()" title="Preview markdown">üëÅÔ∏è</button>
          <button onclick="pasteFromClipboard()" title="Paste from clipboard">üìã</button>
          <button onclick="archiveNote()" title="Archive" style="color:var(--red);">üóÑÔ∏è</button>
        </div>
      </div>
      <div class="editor-meta">
        <label>Category</label>
        <select id="editor-category">
          <option>Ideas</option><option>Tasks</option><option>People</option><option>Research</option><option selected>Random</option>
        </select>
        <label>Tags</label>
        <input type="text" id="editor-tags" placeholder="comma separated" style="flex:1;" />
      </div>
      <div class="editor-body">
        <textarea class="editor-textarea" id="editor-textarea" placeholder="Start writing‚Ä¶"></textarea>
        <div class="markdown-view" id="markdown-view" style="display:none;"></div>
      </div>
    </div>
    <div class="editor-placeholder" id="editor-placeholder">
      <div style="font-size:32px;">‚úèÔ∏è</div>
      <div>Select a note or press <kbd>‚åòN</kbd> to create one</div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ===== State =====
let notes = [];
let currentNote = null;
let currentFilter = { type: 'all' };
let previewMode = false;
let saveTimeout = null;

// ===== API =====
const api = {
  async get(url) { const r = await fetch(url); return r.json(); },
  async post(url, body) { const r = await fetch(url, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) }); return r.json(); },
  async put(url, body) { const r = await fetch(url, { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) }); return r.json(); },
  async del(url) { const r = await fetch(url, { method: 'DELETE' }); return r.json(); },
};

// ===== Load & Render =====
async function loadNotes() {
  let url = '/api/notes?';
  if (currentFilter.type === 'archived') url += 'archived=true&';
  else if (currentFilter.type === 'pinned') url += 'pinned=true&';
  else if (currentFilter.type === 'tag') url += `tag=${encodeURIComponent(currentFilter.value)}&`;
  else if (currentFilter.type === 'category') url += `category=${encodeURIComponent(currentFilter.value)}&`;

  const q = document.getElementById('search').value;
  if (q) url += `search=${encodeURIComponent(q)}&`;

  notes = await api.get(url);
  renderNoteList();
  loadSidebar();
}

function renderNoteList() {
  const el = document.getElementById('note-list');
  if (!notes.length) { el.innerHTML = '<div class="empty-state">No notes yet</div>'; return; }
  el.innerHTML = notes.map(n => `
    <div class="note-card ${currentNote?.id === n.id ? 'active' : ''}" onclick="selectNote('${n.id}')">
      <div class="note-card-title">${n.pinned ? '<span class="pin">‚≠ê</span>' : ''}${esc(n.title || 'Untitled')}</div>
      <div class="note-card-preview">${esc((n.content || '').substring(0, 120))}</div>
      <div class="note-card-meta">
        ${(n.tags||[]).slice(0,3).map(t => `<span class="tag">#${esc(t)}</span>`).join('')}
        <span class="time">${timeAgo(n.modified || n.created)}</span>
      </div>
    </div>
  `).join('');
}

async function loadSidebar() {
  const [tags, cats, allNotes, archivedNotes] = await Promise.all([
    api.get('/api/tags'), api.get('/api/categories'),
    api.get('/api/notes'), api.get('/api/notes?archived=true')
  ]);

  document.getElementById('count-all').textContent = allNotes.length;
  document.getElementById('count-pinned').textContent = allNotes.filter(n => n.pinned).length;
  document.getElementById('count-archived').textContent = archivedNotes.length;

  document.getElementById('category-list').innerHTML = cats.map(c => `
    <div class="sidebar-item ${currentFilter.type==='category'&&currentFilter.value===c.category?'active':''}"
         onclick="filterNotes('category','${esc(c.category)}')">
      <span class="icon">${catIcon(c.category)}</span> ${esc(c.category)} <span class="count">${c.count}</span>
    </div>
  `).join('');

  document.getElementById('tag-list').innerHTML = tags.slice(0,15).map(t => `
    <div class="sidebar-item ${currentFilter.type==='tag'&&currentFilter.value===t.tag?'active':''}"
         onclick="filterNotes('tag','${esc(t.tag)}')">
      <span class="icon">#</span> ${esc(t.tag)} <span class="count">${t.count}</span>
    </div>
  `).join('');
}

function catIcon(c) {
  return { Ideas:'üí°', Tasks:'‚úÖ', People:'üë§', Research:'üî¨', Random:'üé≤' }[c] || 'üìÅ';
}

// ===== Note Selection & Editing =====
async function selectNote(id) {
  await saveCurrentNote();
  const note = await api.get(`/api/notes/${id}`);
  currentNote = note;
  previewMode = false;
  showEditor(note);
  renderNoteList();
  document.getElementById('editor-panel').classList.add('mobile-open');
}

function showEditor(note) {
  document.getElementById('editor-content').style.display = 'flex';
  document.getElementById('editor-placeholder').style.display = 'none';
  document.getElementById('editor-title').value = note.title || '';
  document.getElementById('editor-textarea').value = note.content || '';
  document.getElementById('editor-category').value = note.category || 'Random';
  document.getElementById('editor-tags').value = (note.tags || []).join(', ');
  document.getElementById('btn-pin').classList.toggle('active', note.pinned);
  document.getElementById('editor-textarea').style.display = '';
  document.getElementById('markdown-view').style.display = 'none';
}

function closeEditor() {
  saveCurrentNote();
  currentNote = null;
  document.getElementById('editor-content').style.display = 'none';
  document.getElementById('editor-placeholder').style.display = 'flex';
  document.getElementById('editor-panel').classList.remove('mobile-open');
  renderNoteList();
}

async function newNote() {
  await saveCurrentNote();
  const note = await api.post('/api/notes', { title: '', content: '', tags: [], category: 'Random' });
  currentNote = note;
  showEditor(note);
  document.getElementById('editor-title').focus();
  document.getElementById('editor-panel').classList.add('mobile-open');
  await loadNotes();
}

async function saveCurrentNote() {
  if (!currentNote) return;
  const title = document.getElementById('editor-title').value;
  const content = document.getElementById('editor-textarea').value;
  const category = document.getElementById('editor-category').value;
  const tagsStr = document.getElementById('editor-tags').value;
  const tags = tagsStr.split(',').map(t => t.trim().toLowerCase()).filter(Boolean);

  if (title === currentNote.title && content === currentNote.content &&
      category === currentNote.category && JSON.stringify(tags) === JSON.stringify(currentNote.tags)) return;

  const updated = await api.put(`/api/notes/${currentNote.id}`, { title, content, category, tags });
  currentNote = updated;
  toast('Saved');
}

async function togglePin() {
  if (!currentNote) return;
  const updated = await api.put(`/api/notes/${currentNote.id}`, { pinned: !currentNote.pinned });
  currentNote = updated;
  document.getElementById('btn-pin').classList.toggle('active', updated.pinned);
  toast(updated.pinned ? 'Pinned' : 'Unpinned');
  await loadNotes();
}

async function archiveNote() {
  if (!currentNote) return;
  await api.del(`/api/notes/${currentNote.id}`);
  toast('Archived');
  closeEditor();
  await loadNotes();
}

function togglePreview() {
  previewMode = !previewMode;
  const textarea = document.getElementById('editor-textarea');
  const view = document.getElementById('markdown-view');
  if (previewMode) {
    textarea.style.display = 'none';
    view.style.display = '';
    view.innerHTML = renderMarkdown(textarea.value);
  } else {
    textarea.style.display = '';
    view.style.display = 'none';
  }
}

async function pasteFromClipboard() {
  try {
    const text = await navigator.clipboard.readText();
    if (!currentNote) {
      const note = await api.post('/api/notes', { title: text.substring(0, 60), content: text, tags: [], category: 'Random' });
      currentNote = note;
      showEditor(note);
      await loadNotes();
    } else {
      const ta = document.getElementById('editor-textarea');
      ta.value += (ta.value ? '\n\n' : '') + text;
    }
    toast('Pasted from clipboard');
  } catch { toast('Clipboard access denied'); }
}

// ===== Filters =====
function filterNotes(type, value) {
  currentFilter = { type, value };
  document.querySelectorAll('.sidebar-item').forEach(el => {
    el.classList.toggle('active',
      (el.dataset.filter === type && !value) ||
      (el.getAttribute('onclick') || '').includes(`'${type}','${value}'`)
    );
  });
  loadNotes();
}

// ===== Quick Capture =====
document.getElementById('quick-input').addEventListener('keydown', async (e) => {
  if (e.key === 'Enter' && e.target.value.trim()) {
    const text = e.target.value.trim();
    const title = text.substring(0, 60);
    await api.post('/api/notes', { title, content: text, tags: [], category: 'Random' });
    e.target.value = '';
    toast('Note captured');
    await loadNotes();
  }
});

// ===== Auto-save on typing =====
document.getElementById('editor-textarea').addEventListener('input', () => {
  clearTimeout(saveTimeout);
  saveTimeout = setTimeout(saveCurrentNote, 1500);
});
document.getElementById('editor-title').addEventListener('input', () => {
  clearTimeout(saveTimeout);
  saveTimeout = setTimeout(saveCurrentNote, 1500);
});

// ===== Search =====
let searchTimeout;
document.getElementById('search').addEventListener('input', () => {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(loadNotes, 250);
});

// ===== Keyboard Shortcuts =====
document.addEventListener('keydown', (e) => {
  if ((e.metaKey || e.ctrlKey) && e.key === 'n') { e.preventDefault(); newNote(); }
  if ((e.metaKey || e.ctrlKey) && e.key === 'k') { e.preventDefault(); document.getElementById('search').focus(); }
  if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') { e.preventDefault(); saveCurrentNote(); }
});

// ===== Helpers =====
function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

function timeAgo(dateStr) {
  if (!dateStr) return '';
  const d = new Date(dateStr);
  const now = new Date();
  const diff = (now - d) / 1000;
  if (diff < 60) return 'just now';
  if (diff < 3600) return `${Math.floor(diff/60)}m ago`;
  if (diff < 86400) return `${Math.floor(diff/3600)}h ago`;
  if (diff < 604800) return `${Math.floor(diff/86400)}d ago`;
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

function renderMarkdown(text) {
  // Simple markdown rendering
  return text
    .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
    .replace(/^### (.+)$/gm, '<h3>$1</h3>')
    .replace(/^## (.+)$/gm, '<h2>$1</h2>')
    .replace(/^# (.+)$/gm, '<h1>$1</h1>')
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.+?)\*/g, '<em>$1</em>')
    .replace(/`([^`]+)`/g, '<code>$1</code>')
    .replace(/^- (.+)$/gm, '<li>$1</li>')
    .replace(/^> (.+)$/gm, '<blockquote>$1</blockquote>')
    .replace(/\n{2,}/g, '</p><p>')
    .replace(/\n/g, '<br>')
    .replace(/^/, '<p>').replace(/$/, '</p>');
}

function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 2000);
}

// ===== Init =====
loadNotes();
</script>
</body>
</html>
